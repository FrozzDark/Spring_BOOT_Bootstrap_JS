<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <title>Admin panel</title>
</head>
<body>

<div class="container-fluid">
    <div class="row bg-dark text-white">
        <div class="col-md-6">
            <h5 class="pt-2 text-white">
                <span th:text="${currentUser.getUsername()}">admin</span>
                with roles:
                <th:block th:each="role : ${currentUser.getRoles()}">
                    <span th:if="(${role.getName()} == 'ROLE_ADMIN')" th:utext="ADMIN">ADMIN</span>
                    <span th:if="(${role.getName()} == 'ROLE_USER')" th:utext="USER">USER</span>
                </th:block>
            </h5>
        </div>
        <div class="col-md-6 text-right pt-2">
            <p><a th:href="@{/logout}" class="text-muted">
                Logout
            </a></p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-1 px-0 pt-3  min-vh-100" style="color: white">
            <div class="nav flex-column nav-pills" id="adminUserTab" role="tablist" aria-orientation="vertical">
                <a class="nav-link active" id="adminTab" data-toggle="pill" href="#admin" role="tab"
                   aria-controls="admin"
                   aria-selected="true">Admin</a>
                <a class="nav-link" id="userTab" data-toggle="pill" href="#user" role="tab" aria-controls="user"
                   aria-selected="false">User</a>
            </div>
        </div>

        <div class="col-md-11 px-4 pt-3 pb-3 bg-light">
            <div class="tab-content" id="adminUserTabContent">
                <div class="tab-pane fade show active" id="admin" role="tabpanel" aria-labelledby="adminTab">
                    <h1>
                        Admin panel
                    </h1>
                    <ul class="nav nav-pills mb-3" id="usersTableNewTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="usersTableTab" data-toggle="pill" href="#usersTablePill"
                               role="tab" aria-controls="usersTablePill" aria-selected="true">Users Table</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="newUserTab" data-toggle="pill" href="#newUserPill" role="tab"
                               aria-controls="newUserPill" aria-selected="false">New User</a>
                        </li>
                    </ul>
                    <div class="tab-content border" id="usersTableNewTabContent">
                        <div class="tab-pane fade show active" id="usersTablePill" role="tabpanel"
                             aria-labelledby="usersTableTab">
                            <div class="p-3 mb-2" style="background-color: #e9ecef">
                                <p>
                                <h4>All users</h4>
                                <p>
                            </div>
                            <div class="table-responsive bg-white">
                                <table class="table table-striped">
                                    <thead>
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">Username</th>
                                        <th scope="col">First Name</th>
                                        <th scope="col">Last Name</th>
                                        <th scope="col">Age</th>
                                        <th scope="col">E-mail</th>
                                        <th scope="col">Role</th>
                                        <th scope="col">Edit</th>
                                        <th scope="col">Delete</th>
                                    </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="newUserPill" role="tabpanel" aria-labelledby="newUserTab">
                            <div class="col border bg-light">
                                <p>
                                <h5>Add new user</h5>
                                <p>
                                <div class="row">
                                    <div class="col border bg-white text-center">
                                        <br/>
                                        <form>
                                            <div class="form-group row justify-content-center">
                                                <div class="col-sm-4">
                                                    <label for="usernameNew">Username:</label>
                                                    <br/>
                                                    <input type="text" class="form-control" id="usernameNew"
                                                           placeholder="Enter username">
                                                    <br/>
                                                    <label for="nameNew">First Name:</label>
                                                    <br/>
                                                    <input type="text" class="form-control" id="nameNew"
                                                           placeholder="First name">
                                                    <br/>
                                                    <label for="surnameNew">Last name:</label>
                                                    <br/>
                                                    <input type="text" class="form-control" id="surnameNew"
                                                           placeholder="Last name">
                                                    <br/>
                                                    <label for="ageNew">Age:</label>
                                                    <br/>
                                                    <input type="number" class="form-control" id="ageNew"
                                                           placeholder="Age">
                                                    <br/>
                                                    <label for="emailNew">E-mail address</label>
                                                    <br/>
                                                    <input type="email" class="form-control" id="emailNew"
                                                           placeholder="E-mail">
                                                    <br/>
                                                    <label for="passwordNew">Password</label>
                                                    <br/>
                                                    <input type="password" class="form-control" id="passwordNew"
                                                           placeholder="Password">
                                                    <br/>
                                                    <label for="rolesNew">Role</label>
                                                    <select multiple="multiple" class="form-control" size="2"
                                                            id="rolesNew">
                                                    </select>
                                                </div>
                                            </div>
                                            <button id="addUserBtn" type="submit" class="btn btn-primary">Save</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="tab-pane fade" id="user" role="tabpanel"
                     aria-labelledby="v-pills-profile-tab">
                    <p>
                    <h1>User information page</h1>
                    <p>
                    <div class="col border card-header" style="background-color: #e9ecef">
                        <p>
                        <h4>About User</h4>
                        <p>
                    </div>
                    <div class="table-responsive bg-white">
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Username</th>
                                <th scope="col">First Name</th>
                                <th scope="col">Last Name</th>
                                <th scope="col">Age</th>
                                <th scope="col">E-mail</th>
                                <th scope="col">Role</th>
                            </tr>
                            </thead>
                            <tbody id="currentUsersTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--Edit Modal-->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog"
     aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit User</h5>
                <button type="button" class="close" data-dismiss="modal"
                        aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="idEdit" class="col-form-label">ID:</label>
                        <input type="number" class="form-control" id="idEdit" readonly/>
                    </div>
                    <div class="form-group">
                        <label for="usernameEdit" class="col-form-label">Username:</label>
                        <input type="text" class="form-control" id="usernameEdit"/>
                    </div>
                    <div class="form-group">
                        <label for="nameEdit" class="col-form-label">First Name:</label>
                        <input type="text" class="form-control" id="nameEdit"/>
                    </div>
                    <div class="form-group">
                        <label for="surnameEdit" class="col-form-label">Second Name:</label>
                        <input type="text" class="form-control" id="surnameEdit"/>
                    </div>
                    <div class="form-group">
                        <label for="ageEdit" class="col-form-label">Age:</label>
                        <input type="number" class="form-control" id="ageEdit"/>
                    </div>
                    <div class="form-group">
                        <label for="emailEdit" class="col-form-label">Email:</label>
                        <input type="email" class="form-control" id="emailEdit"/>
                    </div>
                    <div class="form-group">
                        <label for="passwordEdit" class="col-form-label">Password:</label>
                        <input type="password" class="form-control" id="passwordEdit">
                    </div>
                    <div class="mb-3 form-check">
                        <label class="font-weight-bold" for="rolesEdit">Role</label>
                        <select multiple class="form-control" id="rolesEdit"></select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="editUserBtn" type="submit" class="btn btn-primary">Edit</button>
            </div>
        </div>
    </div>
</div>

<!--Delete Modal-->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog"
     aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">New
                    message</h5>
                <button type="button" class="close" data-dismiss="modal"
                        aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="idDelete" class="col-form-label">ID:</label>
                        <input type="number" class="form-control" id="idDelete" readonly/>
                    </div>
                    <div class="form-group">
                        <label for="usernameDelete" class="col-form-label">Username:</label>
                        <input type="text" class="form-control" id="usernameDelete" readonly/>
                    </div>
                    <div class="form-group">
                        <label for="nameDelete" class="col-form-label">First Name:</label>
                        <input type="text" class="form-control" id="nameDelete" readonly/>
                    </div>
                    <div class="form-group">
                        <label for="surnameDelete" class="col-form-label">Second Name:</label>
                        <input type="text" class="form-control" id="surnameDelete" readonly/>
                    </div>
                    <div class="form-group">
                        <label for="ageDelete" class="col-form-label">Age:</label>
                        <input type="number" class="form-control" id="ageDelete" readonly/>
                    </div>
                    <div class="form-group">
                        <label for="emailDelete" class="col-form-label">Email:</label>
                        <input type="email" class="form-control" id="emailDelete" readonly/>
                    </div>
                    <div class="form-group">
                        <label for="passwordDelete" class="col-form-label">Password:</label>
                        <input type="password" class="form-control" id="passwordDelete" readonly/>
                    </div>
                    <div class="mb-3 form-check">
                        <label class="font-weight-bold" for="rolesDelete">Role</label>
                        <select multiple class="form-control" id="rolesDelete" readonly></select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="delUserBtn" type="submit" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>


<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

<script>
    let allUsers;
    let allRoles;

    fetch('/api/roles').then(
        res => {
            res.json().then(
                roles => {
                    allRoles = roles;
                })
        })

    fetch('/api/admins')
        .then(res => {
            res.json()
                .then(
                    data => {
                        allUsers = data;
                        createTable(allUsers);
                    })
        })

    function createTable(data) {
        let temp = "";
        data.forEach(u => {
            console.log(u)
            temp += "<tr id=\"" + u.id + "\">";
            temp += "<td>" + u.id + "</td>";
            temp += "<td>" + u.username + "</td>";
            temp += "<td>" + u.name + "</td>";
            temp += "<td>" + u.surname + "</td>";
            temp += "<td>" + u.age + "</td>";
            temp += "<td>" + u.email + "</td>";
            temp += "<td>";
            let rolesStr = "";
            u.roles.forEach(r => {
                rolesStr += r.name.replaceAll("ROLE_", "") + " ";
            })
            temp += rolesStr + "</td>";
            temp += "<td><button class=\"btn btn-info\" onclick=\"fEdit(" + u.id + ")\" id=\"editBtn" + u.id + "\">Edit</button></td>";
            temp += "<td><button class=\"btn btn-danger\" onclick=\"fDel(" + u.id + ")\" id=\"deleteBtn" + u.id + "\">Delete</button></td>" + "</tr>";
        })
        document.getElementById("usersTableBody").innerHTML = temp;
    }

    fetch('/api/users')
        .then(res => {
                res.json().then(
                    data => {
                        let temp = "";
                        console.log(data)
                        temp += "<tr id=\"" + data.id + "\">";
                        temp += "<td>" + data.id + "</td>";
                        temp += "<td>" + data.username + "</td>";
                        temp += "<td>" + data.name + "</td>";
                        temp += "<td>" + data.surname + "</td>";
                        temp += "<td>" + data.age + "</td>";
                        temp += "<td>" + data.email + "</td>";
                        temp += "<td>";
                        let rolesStr = "";
                        data.roles.forEach(r => {
                            rolesStr += r.name.replaceAll("ROLE_", "") + " ";
                        })
                        temp += rolesStr + "</td>" + "</tr>";
                        document.getElementById("currentUsersTableBody").innerHTML = temp;
                    }
                )
            }
        )

    fetch('/api/roles').then(
        res => {
            res.json().then(
                roles => {
                    let temp = "";
                    console.log(roles)
                    document.getElementById("rolesNew").size = roles.length;
                    roles.forEach(r => {
                        temp += "<option>" + r.name + "</option>";
                    })
                    document.getElementById("rolesNew").innerHTML = temp;
                }
            )
        }
    );
    $('#addUserBtn').click(function () {
        let newUser = {
            username: "",
            name: "",
            surname: "",
            age: "",
            email: "",
            password: "",
            roles: []
        };
        newUser.username = document.getElementById("usernameNew").value;
        newUser.name = document.getElementById("nameNew").value;
        newUser.surname = document.getElementById("surnameNew").value;
        newUser.age = document.getElementById("ageNew").value;
        newUser.email = document.getElementById("emailNew").value;
        newUser.password = document.getElementById("passwordNew").value;
        newUser.roles = [];
        [].slice.call(document.getElementById("rolesNew")).forEach(op => {
            if (op.selected) {
                allRoles.forEach(r => {
                    if (r.name === op.text) {
                        newUser.roles.push(r);
                    }
                })
            }
        })
        fetch('/api/admins', {
            method: 'POST',
            body: JSON.stringify(newUser),
            headers: {'Content-Type': 'application/json'}
        }).then(res1 => {
            if (res1.ok) {
                res1.json().then(u => {
                    allUsers.push(u);
                    createTable(allUsers);
                })
                document.getElementById("usernameNew").value = "";
                document.getElementById("nameNew").value = "";
                document.getElementById("surnameNew").value = "";
                document.getElementById("ageNew").value = "";
                document.getElementById("emailNew").value = "";
                document.getElementById("passwordNew").value = "";
                document.getElementById("rolesNew").selectedIndex = -1;
            } else {
                alert("Не удалось добавить: " + res1.status);
            }
        })
    })

    function getUserById(id) {
        let t = null;
        allUsers.forEach(u => {
            if (u.id === id) {
                t = u;
            }
        })
        return t;
    }

    $('#editUserBtn').click(function () {
        let id = document.getElementById("idEdit").value;
        let edit = {
            id: -1,
            username: "",
            name: "",
            surname: "",
            age: "",
            email: "",
            password: "",
            roles: []
        };
        $('#editModal').modal('hide');
        edit.id = document.getElementById("idEdit").value;
        edit.username = document.getElementById("usernameEdit").value;
        edit.name = document.getElementById("nameEdit").value;
        edit.surname = document.getElementById("surnameEdit").value;
        edit.age = document.getElementById("ageEdit").value;
        edit.email = document.getElementById("emailEdit").value;
        edit.password = document.getElementById("passwordEdit").value;
        edit.roles = [];
        [].slice.call(document.getElementById("rolesEdit")).forEach(op => {
            if (op.selected) {
                allRoles.forEach(r => {
                    if (r.name === op.text) {
                        edit.roles.push(r);
                    }
                })
            }
        })
        console.log(edit)
        fetch('/api/admins' + id, {
            method: 'PUT',
            body: JSON.stringify(edit),
            headers: {'Content-Type': 'application/json'}
        })
            .then(res => {
                if (res.ok) {
                    allUsers.forEach(u => {
                        if (u.id === edit.id) {
                            u.username = edit.username;
                            u.name = edit.name;
                            u.surname = edit.surname;
                            u.age = edit.age;
                            u.email = edit.email;
                            if (edit.password !== "") {
                                u.password = edit.password;
                            }
                            u.roles = edit.roles;
                        }
                    })
                    createTable(allUsers);
                }
            });

    })

    $('#delUserBtn').click(function () {
        let id = document.getElementById("idDelete").value;
        $('#deleteModal').modal('hide');

        fetch('/api/admins' + id, {method: 'DELETE'})
            .then(res => {
                if (res.ok) {
                    document.getElementById(id).remove();
                    let u = getUserById(id);
                    let i = allUsers.indexOf(u);
                    delete allUsers[i];
                }
            });
    })

    function fEdit(el) {
        console.log(el);
        let id = el;
        allUsers.forEach(u => {
            if (u.id === id) {
                console.log(u);
                document.getElementById("idEdit").value = u.id;
                document.getElementById("usernameEdit").value = u.username;
                document.getElementById("nameEdit").value = u.name;
                document.getElementById("surnameEdit").value = u.surname;
                document.getElementById("ageEdit").value = u.age;
                document.getElementById("emailEdit").value = u.email;
                document.getElementById("passwordEdit").value = u.password;
                document.getElementById("rolesEdit").size = allRoles.length;
                let temp = "";
                allRoles.forEach(r => {
                    let select = "";
                    u.roles.forEach(rUser => {
                        if (rUser.id === r.id) {
                            select = " selected";
                        }
                    })
                    temp += "<option" + select + ">" + r.name + "</option>";
                })
                document.getElementById("rolesEdit").innerHTML = temp;
            }
        });
        $('#editModal').modal('show');
    }

    function fDel(el) {
        console.log(el);
        let id = el;
        allUsers.forEach(u => {
            if (u.id === id) {
                console.log(u);
                document.getElementById("idDelete").value = u.id;
                document.getElementById("usernameDelete").value = u.username;
                document.getElementById("nameDelete").value = u.name;
                document.getElementById("surnameDelete").value = u.surname;
                document.getElementById("ageDelete").value = u.age;
                document.getElementById("emailDelete").value = u.email;
                document.getElementById("passwordDelete").value = u.password;
                document.getElementById("rolesDelete").size = u.roles.length.toString();
                let temp = "";
                u.roles.forEach(r => {
                    temp += "<option>" + r.name.replaceAll("ROLE_", "") + "</option>";
                })
                document.getElementById("rolesDelete").innerHTML = temp;
            }
        });
        $('#deleteModal').modal('show');
    }
</script>
</body>
</html>